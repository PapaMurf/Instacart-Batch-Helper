<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Instacart Batch Helper</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #0f172a;
      color: #0f172a;
    }

    .app {
      max-width: 720px;
      margin: 0 auto;
    }

    h1, h2, h3 {
      margin: 0.3rem 0;
    }

    h1 {
      color: #e5e7eb;
      font-size: 1.6rem;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 0.9rem;
      margin-bottom: 0.8rem;
    }

    .card {
      background: #f9fafb;
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 18px 45px rgba(15,23,42,0.35);
    }

    .card-soft {
      box-shadow: 0 8px 24px rgba(15,23,42,0.25);
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.15rem;
      color: #4b5563;
    }

    input, select {
      width: 100%;
      padding: 0.5rem 0.6rem;
      font-size: 1rem;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      box-sizing: border-box;
      margin-bottom: 0.6rem;
      background: #f3f4f6;
      color: #111827;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #2563eb;
      background: #ffffff;
      box-shadow: 0 0 0 1px #2563eb33;
    }

    .row {
      display: flex;
      gap: 0.5rem;
    }

    .row > div {
      flex: 1;
    }

    .btn {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 0.65rem 1rem;
      font-size: 1rem;
      font-weight: 600;
      margin-right: 0.5rem;
      margin-top: 0.3rem;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 8px 20px rgba(34,197,94,0.35);
      width: 100%;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
      width: 100%;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
      width: 100%;
    }

    .results {
      font-size: 0.95rem;
      line-height: 1.4;
      margin-top: 0.6rem;
    }

    .results strong {
      font-weight: 600;
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 700;
      margin-top: 0.3rem;
    }

    .badge-accept {
      background: #22c55e1a;
      color: #166534;
      border: 1px solid #22c55e;
    }

    .badge-maybe {
      background: #facc151a;
      color: #854d0e;
      border: 1px solid #facc15;
    }

    .badge-skip {
      background: #ef44441a;
      color: #b91c1c;
      border: 1px solid #ef4444;
    }

    .small-note {
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* Dashboard styles */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .dashboard-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }

    .dashboard-subtitle {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .goal-summary {
      background: radial-gradient(circle at top left, #dbeafe, #f9fafb);
      border-radius: 14px;
      padding: 0.8rem 0.8rem 0.7rem;
      margin-bottom: 0.7rem;
    }

    .goal-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 0.35rem;
    }

    .goal-title {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .goal-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: #111827;
    }

    .goal-percent {
      font-size: 0.95rem;
      font-weight: 600;
      color: #2563eb;
    }

    .goal-progress-bar {
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: #e5e7eb;
      overflow: hidden;
      margin-bottom: 0.25rem;
    }

    .goal-progress-fill {
      height: 100%;
      width: 0%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #16a34a);
      transition: width 0.3s ease-out;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .stat {
      background: #f3f4f6;
      border-radius: 12px;
      padding: 0.55rem 0.7rem;
    }

    .stat-title {
      color: #6b7280;
      font-size: 0.8rem;
    }

    .stat-value {
      font-weight: 600;
      margin-top: 0.1rem;
      color: #111827;
    }

    .stat-emoji {
      margin-right: 0.25rem;
    }

    .batch-list {
      max-height: 220px;
      overflow-y: auto;
      font-size: 0.85rem;
      margin-top: 0.5rem;
      border-top: 1px solid #e5e7eb;
      padding-top: 0.4rem;
    }

    .batch-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.25rem;
      color: #4b5563;
    }

    .batch-item span {
      white-space: nowrap;
    }

    @media (max-width: 480px) {
      body {
        padding: 0.6rem;
      }

      h1 {
        font-size: 1.4rem;
      }

      .card {
        padding: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Instacart Batch Helper</h1>
    <p class="subtitle">
      Quick batch decisions + monthly goal tracking, right on your phone.
    </p>

    <!-- BATCH EVALUATOR (now at the top) -->
    <div class="card card-soft">
      <h2>üì¶ Batch evaluator</h2>

      <label for="batchDate">Batch date</label>
      <input type="date" id="batchDate" />

      <div class="row">
        <div>
          <label for="batchPay">Base pay ($)</label>
          <input type="number" id="batchPay" step="0.01" inputmode="decimal" />
        </div>
        <div>
          <label for="tipAmount">Tip ($)</label>
          <input type="number" id="tipAmount" step="0.01" inputmode="decimal" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="distanceMiles">Distance (round trip, miles)</label>
          <input type="number" id="distanceMiles" step="0.1" inputmode="decimal" />
        </div>
        <div>
          <label for="timeMinutes">Estimated time (minutes)</label>
          <input type="number" id="timeMinutes" step="1" inputmode="decimal" />
        </div>
      </div>

      <button class="btn btn-primary" id="evaluateBtn">Evaluate batch</button>
      <button class="btn btn-secondary" id="saveBatchBtn">Save batch</button>

      <div id="batchResults" class="results"></div>
    </div>

    <!-- SETTINGS (now below evaluator) -->
    <div class="card card-soft">
      <h2>‚öôÔ∏è Settings</h2>
      <p class="small-note" style="margin-bottom:0.4rem;">
        These are remembered on this device. Change them anytime.
      </p>

      <div class="row">
        <div>
          <label for="mpg">Car efficiency (mpg)</label>
          <input type="number" id="mpg" step="0.1" inputmode="decimal" />
        </div>
        <div>
          <label for="gasPrice">Gas price ($/gal)</label>
          <input type="number" id="gasPrice" step="0.01" inputmode="decimal" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="minNet">Min net per batch ($)</label>
          <input type="number" id="minNet" step="0.1" inputmode="decimal" />
        </div>
        <div>
          <label for="minHourly">Min hourly rate ($/hr)</label>
          <input type="number" id="minHourly" step="0.1" inputmode="decimal" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="month">Month</label>
          <select id="month"></select>
        </div>
        <div>
          <label for="year">Year</label>
          <select id="year"></select>
        </div>
      </div>

      <label for="monthlyGoal">Monthly earnings goal ($)</label>
      <input type="number" id="monthlyGoal" step="1" inputmode="decimal" />

      <button class="btn btn-secondary" id="saveSettingsBtn">Save settings</button>
    </div>

    <!-- MONTHLY SUMMARY -->
    <div class="card card-soft">
      <div class="dashboard-header">
        <div>
          <div class="dashboard-title">üìä Monthly dashboard</div>
          <div class="dashboard-subtitle">Filtered by month & year above</div>
        </div>
      </div>

      <div id="goalSummary" class="goal-summary"></div>

      <div class="stats-grid" id="statsGrid">
        <!-- Filled by JS -->
      </div>

      <div class="batch-list" id="batchList">
        <!-- Filled by JS -->
      </div>

      <button class="btn btn-danger" id="clearDataBtn" style="margin-top:0.5rem;">
        Clear ALL saved batches (careful!)
      </button>
    </div>

    <p class="small-note">
      All data is stored locally in this browser using localStorage.
      Using a different browser or clearing site data will reset the app.
    </p>
  </div>

  <script>
    // ---------- STORAGE KEYS ----------
    const SETTINGS_KEY = 'ic_settings';
    const BATCHES_KEY = 'ic_batches';

    // ---------- DOM ELEMENTS ----------
    const mpgInput = document.getElementById('mpg');
    const gasPriceInput = document.getElementById('gasPrice');
    const minNetInput = document.getElementById('minNet');
    const minHourlyInput = document.getElementById('minHourly');
    const monthSelect = document.getElementById('month');
    const yearSelect = document.getElementById('year');
    const monthlyGoalInput = document.getElementById('monthlyGoal');

    const batchDateInput = document.getElementById('batchDate');
    const batchPayInput = document.getElementById('batchPay');
    const tipAmountInput = document.getElementById('tipAmount');
    const distanceMilesInput = document.getElementById('distanceMiles');
    const timeMinutesInput = document.getElementById('timeMinutes');
    const batchResultsDiv = document.getElementById('batchResults');

    const goalSummaryDiv = document.getElementById('goalSummary');
    const statsGridDiv = document.getElementById('statsGrid');
    const batchListDiv = document.getElementById('batchList');

    const evaluateBtn = document.getElementById('evaluateBtn');
    const saveBatchBtn = document.getElementById('saveBatchBtn');
    const saveSettingsBtn = document.getElementById('saveSettingsBtn');
    const clearDataBtn = document.getElementById('clearDataBtn');

    // ---------- HELPERS ----------
    function loadSettings() {
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) return null;
      try {
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function saveSettings(settings) {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function loadBatches() {
      const raw = localStorage.getItem(BATCHES_KEY);
      if (!raw) return [];
      try {
        return JSON.parse(raw);
      } catch {
        return [];
      }
    }

    function saveBatches(batches) {
      localStorage.setItem(BATCHES_KEY, JSON.stringify(batches));
    }

    function formatMoney(value) {
      return '$' + value.toFixed(2);
    }

    function todayISO() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd}`;
    }

    // Populate month/year selects
    function initMonthYearSelects() {
      const monthNames = [
        'Jan','Feb','Mar','Apr','May','Jun',
        'Jul','Aug','Sep','Oct','Nov','Dec'
      ];
      monthSelect.innerHTML = '';
      yearSelect.innerHTML = '';

      for (let m = 0; m < 12; m++) {
        const opt = document.createElement('option');
        opt.value = m + 1; // 1-12
        opt.textContent = `${m+1} ‚Äì ${monthNames[m]}`;
        monthSelect.appendChild(opt);
      }

      const currentYear = new Date().getFullYear();
      for (let y = currentYear - 1; y <= currentYear + 1; y++) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        yearSelect.appendChild(opt);
      }

      monthSelect.value = new Date().getMonth() + 1;
      yearSelect.value = currentYear;
    }

    // ---------- CORE CALCULATION ----------
    function evaluateBatch(values, thresholds) {
      const {
        batchPay,
        tipAmount,
        distanceMiles,
        timeMinutes,
        gasPrice,
        mpg
      } = values;

      const payout = batchPay + tipAmount;
      const gallonsUsed = mpg > 0 ? distanceMiles / mpg : 0;
      const gasCost = gallonsUsed * gasPrice;
      const net = payout - gasCost;

      const hours = timeMinutes / 60;
      const hourlyRate = hours > 0 ? net / hours : 0;

      const minNet = thresholds.minNet || 0;
      const minHourly = thresholds.minHourly || 0;
      const borderFactor = 0.7;
      const netBorder = minNet * borderFactor;
      const hourlyBorder = minHourly * borderFactor;

      let decision = 'MAYBE';
      let decisionClass = 'badge-maybe';

      if (net >= minNet && hourlyRate >= minHourly) {
        decision = 'ACCEPT';
        decisionClass = 'badge-accept';
      } else if (net < netBorder && hourlyRate < hourlyBorder) {
        decision = 'SKIP';
        decisionClass = 'badge-skip';
      }

      return {
        payout,
        gasCost,
        net,
        hours,
        hourlyRate,
        decision,
        decisionClass
      };
    }

    function renderBatchResults(calc, thresholds) {
      if (!calc) {
        batchResultsDiv.innerHTML = '';
        return;
      }

      const { payout, gasCost, net, hourlyRate, decision, decisionClass } = calc;

      batchResultsDiv.innerHTML = `
        <div>
          <div><strong>Total payout:</strong> ${formatMoney(payout)}</div>
          <div><strong>Gas cost:</strong> ${formatMoney(gasCost)}</div>
          <div><strong>Net earnings:</strong> ${formatMoney(net)}</div>
          <div><strong>Effective hourly rate:</strong> ${formatMoney(hourlyRate)}</div>
          <div style="margin-top:0.3rem;">
            <span class="badge ${decisionClass}">${decision}</span>
          </div>
          <div class="small-note" style="margin-top:0.3rem;">
            Thresholds: ‚â• ${formatMoney(thresholds.minNet || 0)} net &amp; ‚â• ${formatMoney(thresholds.minHourly || 0)} / hr.
          </div>
        </div>
      `;
    }

    function updateMonthlySummary() {
      const settings = loadSettings() || {};
      const batches = loadBatches();
      const month = parseInt(monthSelect.value, 10);
      const year = parseInt(yearSelect.value, 10);
      const monthlyGoal = Number(monthlyGoalInput.value) || 0;

      const filtered = batches.filter(b => {
        const d = new Date(b.date);
        const m = d.getMonth() + 1;
        const y = d.getFullYear();
        return m === month && y === year;
      });

      let totalNet = 0;
      let totalMinutes = 0;

      filtered.forEach(b => {
        totalNet += b.net;
        totalMinutes += b.timeMinutes || 0;
      });

      const numBatches = filtered.length;
      const remaining = Math.max(monthlyGoal - totalNet, 0);
      const avgNet = numBatches > 0 ? totalNet / numBatches : 0;
      const batchesLeft = (avgNet > 0 && remaining > 0)
        ? Math.ceil(remaining / avgNet)
        : 0;
      const totalHours = totalMinutes / 60;
      const overallHourly = totalHours > 0 ? totalNet / totalHours : 0;

      const percent = monthlyGoal > 0 ? Math.min((totalNet / monthlyGoal) * 100, 999) : 0;
      const displayPercent = monthlyGoal > 0 ? percent.toFixed(0) + '%' : '‚Äî';

      // Goal summary header + progress bar
      goalSummaryDiv.innerHTML = `
        <div class="goal-header">
          <div>
            <div class="goal-title">This month</div>
            <div class="goal-amount">${formatMoney(totalNet)} / ${formatMoney(monthlyGoal)}</div>
          </div>
          <div class="goal-percent">${displayPercent}</div>
        </div>
        <div class="goal-progress-bar">
          <div class="goal-progress-fill" style="width:${Math.min(percent, 100)}%;"></div>
        </div>
        <div class="small-note">
          Remaining: ${formatMoney(remaining)} ¬∑ Est. batches left: ${batchesLeft}
        </div>
      `;

      // Stats grid
      statsGridDiv.innerHTML = `
        <div class="stat">
          <div class="stat-title">
            <span class="stat-emoji">üßæ</span> Batches this month
          </div>
          <div class="stat-value">${numBatches}</div>
        </div>
        <div class="stat">
          <div class="stat-title">
            <span class="stat-emoji">üí∏</span> Total net this month
          </div>
          <div class="stat-value">${formatMoney(totalNet)}</div>
        </div>
        <div class="stat">
          <div class="stat-title">
            <span class="stat-emoji">üìâ</span> Remaining to goal
          </div>
          <div class="stat-value">${formatMoney(remaining)}</div>
        </div>
        <div class="stat">
          <div class="stat-title">
            <span class="stat-emoji">üì¶</span> Avg net / batch
          </div>
          <div class="stat-value">${numBatches > 0 ? formatMoney(avgNet) : '‚Äî'}</div>
        </div>
        <div class="stat">
          <div class="stat-title">
            <span class="stat-emoji">‚è±Ô∏è</span> Total hours (est.)
          </div>
          <div class="stat-value">${totalHours.toFixed(1)} h</div>
        </div>
        <div class="stat">
          <div class="stat-title">
            <span class="stat-emoji">‚ö°</span> Overall hourly
          </div>
          <div class="stat-value">${totalHours > 0 ? formatMoney(overallHourly) : '‚Äî'}</div>
        </div>
      `;

      // Batch list
      batchListDiv.innerHTML = '';
      if (filtered.length > 0) {
        filtered
          .sort((a, b) => new Date(a.date) - new Date(b.date))
          .forEach(b => {
            const d = new Date(b.date);
            const label = `${d.getMonth()+1}/${d.getDate()}`;
            const item = document.createElement('div');
            item.className = 'batch-item';
            item.innerHTML = `
              <span>${label}</span>
              <span>${formatMoney(b.net)} net</span>
              <span>${b.timeMinutes || 0} min</span>
            `;
            batchListDiv.appendChild(item);
          });
      }
    }

    // ---------- INIT ----------
    function init() {
      initMonthYearSelects();
      batchDateInput.value = todayISO();

      const settings = loadSettings();
      if (settings) {
        if (settings.mpg != null) mpgInput.value = settings.mpg;
        if (settings.gasPrice != null) gasPriceInput.value = settings.gasPrice;
        if (settings.minNet != null) minNetInput.value = settings.minNet;
        if (settings.minHourly != null) minHourlyInput.value = settings.minHourly;
        if (settings.monthlyGoal != null) monthlyGoalInput.value = settings.monthlyGoal;
        if (settings.month != null) monthSelect.value = settings.month;
        if (settings.year != null) yearSelect.value = settings.year;
      } else {
        // sensible defaults
        mpgInput.value = 25;
        gasPriceInput.value = 3.5;
        minNetInput.value = 15;
        minHourlyInput.value = 20;
        monthlyGoalInput.value = 1200;
      }

      updateMonthlySummary();
    }

    // ---------- EVENT LISTENERS ----------
    evaluateBtn.addEventListener('click', () => {
      const settings = loadSettings() || {};
      const thresholds = {
        minNet: Number(minNetInput.value) || settings.minNet || 0,
        minHourly: Number(minHourlyInput.value) || settings.minHourly || 0
      };

      const values = {
        batchPay: Number(batchPayInput.value) || 0,
        tipAmount: Number(tipAmountInput.value) || 0,
        distanceMiles: Number(distanceMilesInput.value) || 0,
        timeMinutes: Number(timeMinutesInput.value) || 0,
        gasPrice: Number(gasPriceInput.value) || 0,
        mpg: Number(mpgInput.value) || 1
      };

      const calc = evaluateBatch(values, thresholds);
      renderBatchResults(calc, thresholds);
    });

    saveBatchBtn.addEventListener('click', () => {
      const dt = batchDateInput.value || todayISO();
      const settings = loadSettings() || {};
      const thresholds = {
        minNet: Number(minNetInput.value) || settings.minNet || 0,
        minHourly: Number(minHourlyInput.value) || settings.minHourly || 0
      };

      const values = {
        batchPay: Number(batchPayInput.value) || 0,
        tipAmount: Number(tipAmountInput.value) || 0,
        distanceMiles: Number(distanceMilesInput.value) || 0,
        timeMinutes: Number(timeMinutesInput.value) || 0,
        gasPrice: Number(gasPriceInput.value) || 0,
        mpg: Number(mpgInput.value) || 1
      };

      const calc = evaluateBatch(values, thresholds);

      const batches = loadBatches();
      batches.push({
        date: dt,
        net: calc.net,
        payout: calc.payout,
        gasCost: calc.gasCost,
        distanceMiles: values.distanceMiles,
        timeMinutes: values.timeMinutes
      });
      saveBatches(batches);

      renderBatchResults(calc, thresholds);
      updateMonthlySummary();

      alert('Batch saved.');
    });

    saveSettingsBtn.addEventListener('click', () => {
      const settings = {
        mpg: Number(mpgInput.value) || 0,
        gasPrice: Number(gasPriceInput.value) || 0,
        minNet: Number(minNetInput.value) || 0,
        minHourly: Number(minHourlyInput.value) || 0,
        monthlyGoal: Number(monthlyGoalInput.value) || 0,
        month: Number(monthSelect.value),
        year: Number(yearSelect.value)
      };
      saveSettings(settings);
      updateMonthlySummary();
      alert('Settings saved.');
    });

    monthSelect.addEventListener('change', () => {
      const settings = loadSettings() || {};
      settings.month = Number(monthSelect.value);
      saveSettings(settings);
      updateMonthlySummary();
    });

    yearSelect.addEventListener('change', () => {
      const settings = loadSettings() || {};
      settings.year = Number(yearSelect.value);
      saveSettings(settings);
      updateMonthlySummary();
    });

    monthlyGoalInput.addEventListener('change', () => {
      const settings = loadSettings() || {};
      settings.monthlyGoal = Number(monthlyGoalInput.value) || 0;
      saveSettings(settings);
      updateMonthlySummary();
    });

    clearDataBtn.addEventListener('click', () => {
      if (!confirm('Really delete ALL saved batches? This cannot be undone.')) return;
      saveBatches([]);
      updateMonthlySummary();
    });

    // ---------- START ----------
    init();
  </script>
</body>
</html>
